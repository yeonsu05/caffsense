import time
import math
import matplotlib.pyplot as plt
from datetime import datetime, timedelta

from HW_605 import measure_hr
from gsr_sensor import measure_gsr


# =============================
# ì„¤ì •ê°’
# =============================
MEASURE_INTERVAL_MIN = 1

CAFFEINE_DB = { "ì•„ë©”ë¦¬ì¹´ë…¸": 100 }


# ===== ê·¸ë˜í”„ ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸ =====
time_log = []
HR_log = []
GSR_log = []
S_log = []
alpha_log = []
beta_log = []
C_log = []
R_log = []


def save_and_plot(t_min, HR, GSR, S, alpha, beta, C, R):
    time_log.append(t_min)
    HR_log.append(HR)
    GSR_log.append(GSR)
    S_log.append(S)
    alpha_log.append(alpha)
    beta_log.append(beta)
    C_log.append(C)
    R_log.append(R)


def plot_final_graph():
    plt.figure(figsize=(12, 7))
    plt.plot(time_log, S_log, label="S-value")
    plt.plot(time_log, C_log, label="C(t) - Caffeine")
    plt.plot(time_log, R_log, label="R(t) - Arousal")

    plt.xlabel("Time (min)")
    plt.ylabel("Value")
    plt.title("Real-time CaffSense Graph")
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()


# =============================
# 1) S-value
# =============================
def calculate_S(H_now, H_prev, G_now, G_prev, dt_seconds):

    if dt_seconds <= 0 or H_prev is None or G_prev is None:
        return 0.0
    
    dH_dt = (H_now - H_prev) / dt_seconds
    dG_dt = (G_now - G_prev) / dt_seconds

    return (0.6 * dH_dt + 0.4 * dG_dt) * 10.0


# =============================
# 2) Î± í˜•ì„±ë¥ 
# =============================
def update_alpha(alpha_prev, S):
    gamma_rise = 0.2
    gamma_decay = 0.05

    if S > 0:
        return (1 - gamma_rise) * alpha_prev + gamma_rise * S
    else:
        return (1 - gamma_decay) * alpha_prev


# =============================
# 3) Î² íšŒë³µë¥ 
# =============================
def calculate_beta(H_peak, H_now, G_peak, G_now, t_peak, t_now):

    if H_peak is None or G_peak is None:
        return 0.0

    dt = t_now - t_peak
    if dt <= 0:
        return 0.0

    try:
        beta_hr = (math.log(H_peak) - math.log(H_now)) / dt
        beta_gs = (math.log(G_peak) - math.log(G_now)) / dt
    except:
        return 0.0

    return 10.0 * (0.6 * beta_hr + 0.4 * beta_gs)


# =============================
# 4) C(t) â€” ì¹´í˜ì¸ ë†ë„ (ì‹¤ì‹œê°„ìš©, ê¸°ë³¸ ë°˜ê°ê¸° 5h)
# =============================
def update_caffeine(C_prev, new_doses, dt, S_prev, S_now):

    if dt <= 0:
        return C_prev + sum(new_doses)

    HALF_LIFE_HOURS = 5.0  # ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ìš© ê¸°ë³¸ê°’
    k = math.log(2) / HALF_LIFE_HOURS

    dt_hours = dt / 3600.0

    C_decay = C_prev * math.exp(-k * dt_hours)
    C_add = sum(new_doses)

    return C_decay + C_add


# =============================
# 5) R(t)
# =============================
def calculate_R(alpha, beta, C, t_min):
    t_hr = t_min / 60.0
    return alpha * C - beta * t_hr


# =============================
# 6) ê°œì¸ ë°˜ê°ê¸° ê³„ì‚° (S-log ê¸°ë°˜)
# =============================
def calculate_personal_half_life(S_history):
    """
    S_history: ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“  S-value ë¦¬ìŠ¤íŠ¸
    ê°œì¸ ë°˜ê°ê¸° ê³„ì‚° (ì„¼ì„œ ê¸°ë°˜ ê°œì¸í™”)
    """
    if len(S_history) == 0:
        return 5.0  # ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ë³¸ê°’

    S_avg = sum(S_history) / len(S_history)

    # Sê°€ í´ìˆ˜ë¡ ëŒ€ì‚¬ ë¹ ë¦„ â†’ ë°˜ê°ê¸° ì§§ê²Œ
    # ê¸°ë³¸ 5.0hì—ì„œ S_avgì— ë”°ë¼ 2.0~7.0h ì‚¬ì´ë¡œ íŠœë‹
    personal_half_life = 5.0 / (1 + 0.1 * abs(S_avg))
    personal_half_life = max(2.0, min(7.0, personal_half_life))

    return personal_half_life



# ============================================================
# 7) ìˆ˜ë©´ ì˜ˆì¸¡ í•¨ìˆ˜ (ë°˜ê°ê¸° ê°œì¸í™” + íšŒë³µ ë¶ˆê°€ ì œê±°)
# ============================================================
def predict_sleep_time(drink_log, HALF_LIFE_HOURS, R_now, alpha, beta, gamma):
    """
    drink_log : [(t_i, mg), ...]
    HALF_LIFE_HOURS : ê°œì¸ ë°˜ê°ê¸° (ì‹œê°„)
    R_now : í˜„ì¬ ì‹œì ì˜ R(t)
    alpha, beta, gamma : ê¸°ì¡´ ëª¨ë¸ íŒŒë¼ë¯¸í„° (í˜•íƒœ ë§ì¶”ê¸°ìš©)
    """

    # ìŒë£Œ ì•ˆ ë§ˆì…¨ìœ¼ë©´ ì´ë¯¸ ìˆ˜ë©´ ê°€ëŠ¥
    if not drink_log:
        return "ì´ë¯¸ ìˆ˜ë©´ ê°€ëŠ¥"

    # 1) ì˜¤ëŠ˜ ë§ˆì‹  ì´ ì¹´í˜ì¸ ì–‘
    total_dose = sum(D for (_, D) in drink_log)

    # 2) ì¹´í˜ì¸ ê°ì‡  ìƒìˆ˜ (ì´ˆ ë‹¨ìœ„)
    k = math.log(2) / (HALF_LIFE_HOURS * 3600.0)

    # 3) ìˆ˜ë©´ ê¸°ì¤€ê°’ (ìƒëŒ€ ê¸°ì¤€ + ìµœì†Œê°’)
    #    ì´ì„­ì·¨ëŸ‰ì˜ 20% ì´í•˜ê°€ ë˜ë©´ ìˆ˜ë©´ì— í° ì˜í–¥ ì—†ë‹¤ê³  ê°€ì •
    C_sleep_threshold = max(total_dose * 0.2, 5.0)

    #    Rë„ í˜„ì¬ ê°’ì˜ 30% ì´í•˜ + ìµœì†Œ 1.0 ì´í•˜ë¡œ ë‚´ë ¤ê°€ë©´ OK
    R_sleep_threshold = max(R_now * 0.3, 1.0)

    # 4) ì˜ˆì¸¡ ì„¤ì •
    dt = 300                # 5ë¶„ ê°„ê²© (ì´ˆ)
    future_hours = 24       # ìµœëŒ€ 24ì‹œê°„ê¹Œì§€ ì˜ˆì¸¡
    lambda_decay = 0.15     # R ìì—°ê°ì‡ ìœ¨ (ì‹œê°„ë‹¹ ì•½ 15% ê°ì†Œ)

    R = R_now
    t_now = time.time()

    for step in range(int((future_hours * 3600) / dt)):
        t_future = t_now + step * dt

        # ---- C(t) ë¯¸ë˜ ì˜ˆì¸¡ ----
        C = 0.0
        for (ti, Di) in drink_log:
            if t_future >= ti:
                C += Di * math.exp(-k * (t_future - ti))

        # ---- R(t) ë¯¸ë˜ ì˜ˆì¸¡ ----
        # R_new = R_old * exp(-Î»Î”t) + Î± * C * Î”t
        dt_hr = dt / 3600.0
        R = R * math.exp(-lambda_decay * dt_hr) + alpha * C * dt_hr

        if R < 0:
            R = 0.0

        # ---- ìˆ˜ë©´ ì¡°ê±´ ê²€ì‚¬ ----
        if C <= C_sleep_threshold and R <= R_sleep_threshold:
            sleep_time = datetime.now() + timedelta(seconds=step * dt)
            return sleep_time.strftime("%H:%M")

    # ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ 24ì‹œê°„ ì•ˆì— ê¸°ì¤€ì„ ëª» ë„˜ì—ˆë‹¤ëŠ” ëœ» â†’ ê·¸ë˜ë„ "íšŒë³µ ë¶ˆê°€"ëŠ” ì•ˆ ì°ê³ 
    # ê·¸ëƒ¥ 24ì‹œê°„ í›„ ì‹œê°ì„ ìµœëŒ€ ì˜ˆì¸¡ê°’ìœ¼ë¡œ ë°˜í™˜
    sleep_time = datetime.now() + timedelta(hours=future_hours)
    return sleep_time.strftime("%H:%M (ìµœëŒ€ ì˜ˆì¸¡)")


# =============================
# 8) ë©”ì¸
# =============================
def main():
    print("\n=== CaffSense (1ë¶„ ê°„ê²© í…ŒìŠ¤íŠ¸ ë²„ì „) ===\n")

    C = 0.0
    t_min = 0

    prev_HR = None
    prev_GSR = None
    prev_time = None

    alpha = 0.0
    prev_S = 0.0

    H_peak = None
    G_peak = None
    t_peak = None

    drink_log = []  # ìˆ˜ë©´ì˜ˆì¸¡ì— í•„ìš”


    while True:
        print(f"\n--- {t_min}ë¶„ ê²½ê³¼ ì¸¡ì • ---\n")

        # ==========================
        # ì¹´í˜ì¸ ì…ë ¥
        # ==========================
        drink = input("ì„­ì·¨ ìŒë£Œ? (ì•„ë©”ë¦¬ì¹´ë…¸ / ì—”í„°): ").strip()
        new_doses = []
        if drink in CAFFEINE_DB:
            dose = CAFFEINE_DB[drink]
            new_doses.append(dose)
            drink_log.append((time.time(), dose))
            print(f"[INFO] +{dose} mg ì¶”ê°€")

        # ==========================
        # ìƒì²´ì‹ í˜¸ ì¸¡ì •
        # ==========================
        HR_now = measure_hr(10)
        G_now = measure_gsr()
        t_now = time.time()

        print(f"HR = {HR_now}, GSR = {G_now}")

        if HR_now == 0.0:
            if prev_HR is not None:
                print("[WARN] HR=0 â†’ ì´ì „ HR ì‚¬ìš©")
                HR_now = prev_HR
            else:
                print("[ERROR] HR baseline ì—†ìŒ â†’ skip")
                C = C + sum(new_doses)
                prev_time = t_now
                t_min += MEASURE_INTERVAL_MIN
                time.sleep(60)
                continue

        # ==========================
        # ì²« íšŒì°¨ ì²˜ë¦¬
        # ==========================
        if prev_time is None:
            dt = 60
            H_peak = HR_now
            G_peak = G_now
            t_peak = t_now
            S_now = 0
            beta = 0
        else:
            dt = t_now - prev_time
            S_now = calculate_S(HR_now, prev_HR, G_now, prev_GSR, dt)
            alpha = update_alpha(alpha, S_now)

            if HR_now > H_peak:
                H_peak = HR_now
                G_peak = G_now
                t_peak = t_now

            beta = calculate_beta(H_peak, HR_now, G_peak, G_now, t_peak, t_now)

        print(f"S-value = {S_now}")
        print(f"Î± = {alpha}")
        print(f"Î² = {beta}")

        # ==========================
        # C(t)
        # ==========================
        C = update_caffeine(C, new_doses, dt, prev_S, S_now)
        print(f"C(t) = {C}")

        # ==========================
        # R(t)
        # ==========================
        R = calculate_R(alpha, beta, C, t_min)
        print(f"R(t) = {R}")

        save_and_plot(t_min, HR_now, G_now, S_now, alpha, beta, C, R)

        # ==========================
        # ğŸ”¥ ìˆ˜ë©´ ì˜ˆì¸¡ ì¶œë ¥ (ê°œì¸ ë°˜ê°ê¸° ì ìš©)
        # ==========================
        personal_half_life = calculate_personal_half_life(S_log)

        sleep_time = predict_sleep_time(
            drink_log,
            personal_half_life,  # â† ì—¬ê¸°ì„œ ê°œì¸ ë°˜ê°ê¸° ì‚¬ìš©
            R,
            alpha,
            beta,
            0
        )
        print(f"[ìˆ˜ë©´ ì˜ˆì¸¡] ì¶”ì²œ ì·¨ì¹¨ ê°€ëŠ¥ ì‹œê°„ â†’ {sleep_time}")

        # ìƒíƒœ ì—…ë°ì´íŠ¸
        prev_HR = HR_now
        prev_GSR = G_now
        prev_time = t_now
        prev_S = S_now

        if t_min > 0:
            stop_check = input("ì¸¡ì •ì„ ì¢…ë£Œí•˜ë ¤ë©´ 'q' ì…ë ¥ (ê³„ì†í•˜ë ¤ë©´ ì—”í„°): ").strip()
            if stop_check.lower() == "q":
                print("\nì¸¡ì • ì¢…ë£Œ!")
                break

        print("\n1ë¶„ ëŒ€ê¸°...\n")
        time.sleep(60)

        t_min += MEASURE_INTERVAL_MIN



if __name__ == "__main__":
    main()

    show_graph = input("\nê·¸ë˜í”„ ì¶œë ¥í• ê¹Œìš”? (y/n): ").strip().lower()
    if show_graph == 'y':
        plot_final_graph()
    else:
        print("ê·¸ë˜í”„ ì¶œë ¥ ìƒëµë¨.")
